# 期货回测系统设计文档

系统采用模块化架构，按照功能划分为数据模块、策略模块、回测引擎、统计分析模块和报告输出模块等。

## 项目结构与模块划分

- data/（数据模块）– 提供历史行情数据的导入、处理与缓存。包括从CSV读取多频率K线数据、解析标准化字段以及数据缓存等组件。
- strategy/（策略模块）– 定义策略接口和持仓信号生成。用户可通过实现策略类或提供持仓序列来指定在各时间段的持仓变化。支持设定交易细节如滑点和手续费。
- engine/（回测引擎模块）– 回测核心模块，驱动整个模拟交易流程。根据时间轴推进行情，并根据策略信号执行开平仓操作（考虑滑点和手续费），支持多周期数据对齐和多线程优化。
- stats/（统计分析模块）– 对回测结果进行绩效评估与可视化。计算策略各项关键指标（如收益率、夏普率、最大回撤等），并生成收益曲线、回撤曲线、持仓情况等图表。
- report/（报告输出模块）– 将回测结果整理成报告输出。包括生成包含策略说明、参数配置、绩效指标和图表的HTML/PDF报告，以及导出详细交易流水和净值曲线的Excel报表。

## 数据模块设计

数据模块负责读取和提供历史行情数据。主要功能和设计如下：

- 数据导入与格式标准化：支持从CSV文件批量导入期货历史数据（包括分钟线和日线等不同频率的K线）。CSV数据需包含时间戳、开盘价、收盘价、最高价、最低价、成交量、持仓量等字段。模块提供解析器将不同来源的原始数据格式转换为标准格式，例如将日期时间字符串解析为datetime对象，将价格/量等字段转换为浮点或整数类型统一单位。导入后数据以Pandas DataFrame或类似数据结构存储，每个K线周期的数据集设置索引为时间戳，列包括 Open, High, Low, Close, Volume, OpenInterest 等，以便后续模块方便查询。
- 多频率支持：系统需支持1分钟、5分钟、10分钟、30分钟及日线等多种频率的数据。在设计上，可以为不同频率维护独立的数据集。例如采用字典结构按频率存储DataFrame：data['1min']、data['5min'] 等。对于较低频率（日线）数据，可通过程序在回测前预先将分钟数据聚合(resample)得到，或直接读取提供的日线CSV。数据模块应提供接口让回测引擎按需获取指定频率、指定合约的行情。例如：get_bar(symbol, datetime, freq) 返回某合约在给定时间点和频率上的行情bar数据。如果策略需要跨周期数据（例如策略信号用日线，但回测以分钟频率执行），数据模块需要提供同步机制，将较低频率的数据对齐到高频时间轴（例如为每天的首个分钟bar附加当天日线信号）。
- 数据缓存机制：为加速回测，数据模块实现缓存策略。第一次从CSV文件读取大量历史数据后，可将处理后的DataFrame缓存到内存，供后续重复回测直接使用，避免重复I/O开销。可以设计一个DataLoader/DataCache类，将最近使用的数据保存在内存字典中，键为(合约, 周期)标识，值为对应的DataFrame。对于超大数据集，也可考虑使用本地持久化缓存（例如将标准化后的数据序列序列化存储为二进制格式如HDF5或pickle），下次启动时优先加载缓存以减少CSV解析时间。缓存机制需设计失效更新策略，例如当源CSV更新或用户请求不同数据范围时能够识别并重新加载。通过数据缓存，能有效提升频繁回测时的数据读取速度。

数据模块可使用Python的Pandas/Polars库进行CSV读取和DataFrame操作。对于CSV解析中的日期时间，可以使用pd.to_datetime或pl.str.to_datetime进行转换。缓存可通过字典或functools.lru_cache等机制实现，必要时借助PyArrow或HDFStore进行持久化存储。总之，数据模块提供干净的接口（如load_data(csv_path, symbol, freq)或get_history(symbol, start, end, freq)）供引擎和策略调用，确保其他模块无需关心底层数据读写细节，实现策略与数据的解耦。

## 策略模块设计

策略模块定义策略的持仓信号产生方式和交易规则，向回测引擎提供在各时间步应该持有的仓位。设计要点如下：
- 策略信号接口：为了最大程度灵活地定义交易策略，策略模块提供两种使用方式：其一，策略类接口，即定义一个Strategy基类，用户通过继承该基类并实现特定方法（如on_bar()或next()）来根据传入的行情数据决定买卖信号；其二，持仓序列输入接口，允许用户直接传入预先计算好的持仓时间序列。对于后一种情况，持仓序列可以用时间索引的结构（如DataFrame或字典）表示，每个时间点给出各合约的目标持仓，例如{时间: 持仓手数}或{时间: 仓位方向/比例}。引擎将在回测过程中读取该持仓序列，按照时间推进更新持仓。
- 逐Bar持仓变更：策略信号可以按指定周期频率产生。例如用户策略设定每1分钟调整仓位一次，则每分钟Bar都会给出新的目标仓位（可能与前一周期相同则表示持仓不变）。系统支持逐Bar下单模式，即假设策略在某Bar时刻决定开仓或平仓，则默认执行规则是：在该Bar的开盘价建仓（开新仓或者加仓/减仓），在指定的Bar时机收盘价平仓（如当策略决定在某Bar结束时退出持仓，则按该Bar收盘价计算平仓)。策略模块可以提供配置参数或不同策略基类来切换下单逻辑。例如，有的策略类实现为当on_bar被调用时即以该Bar开盘价下单，上一个持仓若需平仓也在同一开盘完成；另一些策略实现则可选择在Bar收盘时再执行交易。
- 持仓序列接口则可约定：当持仓指令在某时间点发生变化时，视为在该Bar开盘时执行仓位调整，如果下一个时间点持仓变为0则在前一信号持续到的Bar收盘时平仓。
- 滑点与手续费设置：为贴近真实交易并评估交易成本，对每笔交易可设置滑点和手续费。策略模块应提供参数来配置滑点和手续费率（买卖双边可以分别设置）。滑点可以用绝对价格差或比例表示，例如设置为0.1%表示模拟成交价比理想价差0.1%的不利偏移；实现时，对于买入单，可在信号价基础上(1+滑点)*提高买价，对卖出单则降低卖价以模拟滑点影响。手续费可以根据交易合约数收取固定费用或按成交金额的比例收取。例如国内股指期货一般按合约手数收取固定手续费，系统可在策略参数中设定每手开仓和平仓的费用（双边费率）。在模拟交易时，每次开仓和平仓操作都应扣减相应手续费。策略模块本身主要是存储和提供这些交易成本参数，具体计算在引擎执行交易时处理。通过将滑点和手续费设为策略配置，用户能够方便地调整不同交易成本情景下策略的业绩表现。

策略模块可以包含一个抽象基类StrategyBase定义通用接口，例如on_bar(bar_data)方法以及on_start(), on_finish()钩子。在基类中还可包含策略元信息（策略名称、描述）、参数配置加载等功能。对于持仓序列驱动的策略，可实现一个子类如SignalStrategy，其构造函数接受一系列时间—持仓信号的数据，如Pandas的Series或DataFrame。on_bar()实现为检查当前Bar时间是否在信号序列中，若是则调整目标持仓。策略模块应与回测引擎通过明确定义的接口交互：例如引擎每推进一个Bar，会调用策略的on_bar()并传入当前行情，策略内部再决定是否修改仓位或发出订单。滑点和手续费参数可以简单地保存在策略实例属性中，供引擎在撮合交易时引用。开发中可利用Python的面向对象特性来实现策略接口，多策略可通过继承实现不同逻辑；同时利用配置文件或JSON传参方式让用户调节滑点、手续费等参数。

## 回测引擎设计

回测引擎是整个系统的核心，负责时间推进、信号撮合执行和结果记录。它连接数据模块和策略模块，将历史数据仿真成交易过程。设计要点如下：

- 多周期数据协调：引擎应支持不同时间周期的回测，并能够协调策略信号与行情数据的时间戳对齐。如果策略信号频率与行情数据频率不一致（例如策略根据日线信号，但回测使用1分钟级行情执行），引擎需要在模拟过程中正确处理这种频率差异。实现上，可以设定一个基准回测周期（如以1分钟为基本步长），引擎循环遍历每个基准周期的Bar。当较低频率的数据到达时（比如日线信号一般在每日收盘后得到），可以在当日第一个Bar或最后一个Bar触发策略信号改变。同样，如果用户提供的持仓序列本身带有时间戳，引擎应将其对齐到最近的交易时点执行。例如：策略序列在每天09:30产生信号，则可视为在对应日内第一个1分钟Bar开盘时执行持仓调整。对于多周期切换，系统也支持纯单一周期回测（例如直接按日线级别回测），此时引擎每步前进一天的数据，不需细粒度对齐。总之，引擎需要对不同频率的信号和数据做好匹配，确保策略意图正确体现在交易执行上。
- 模拟撮合与多线程优化：引擎在每个时间步需要完成：获取当前Bar行情数据、更新策略目标持仓、计算需要执行的交易（开仓/平仓）、按照设置的滑点和手续费撮合成交，并记录交易明细和资金变动。为了提高回测效率，需优化这一循环过程。针对单策略单标的，可以利用向量化或逐步优化Python循环；对于多合约或多策略组合，可以考虑并行计算。例如，在组合策略回测中，不同合约的行情推进和持仓计算可以在多个线程或进程中并行处理，然后再汇总结果（注意并发处理需确保线程安全，如对共享资金曲线加锁等）。Python由于GIL限制，多线程并不一定加速CPU计算，此时可以尝试多进程（multiprocessing）或使用Numba对密集计算的部分加速。对于I/O密集的部分（如从缓存获取数据），多线程还是有帮助的。总之，引擎模块应设计为可并发扩展的：可以在配置上允许开启多线程/多进程模式。内部实现上，可将不同合约的数据迭代封装为独立的任务，由线程池并行执行回测逻辑，最后由主线程合并各合约的交易记录和资金曲线。除了并行，使用矢量化计算也是提升性能的途径：例如可用Pandas一次性计算整个回测周期的逐Bar收益率等，不必每步循环实时计算。引擎的设计需在易读易维护和性能之间权衡，针对大规模数据回测提供优化方案。
- 交易执行与记录：引擎需要完整模拟每个Bar的交易，并输出详细结果。具体包括：开盘跳空收益的计算、Bar内持仓收益计算，以及持仓变动与成交记录。开盘跳空收益是指当前Bar开盘价相对于上一Bar收盘价的变动收益（例如昨日收盘到今日开盘的价格涨跌幅）；Bar内收益则指当期收盘价相对于开盘价的涨跌幅，即(收盘价/开盘价 - 1)。引擎在每步应计算这两部分收益率，以便日后分析策略在跳空和日内的收益贡献。持仓路径记录方面，引擎需要维护一个随时间变化的持仓状态序列，表明每个时间点上策略持有多头、空头还是空仓以及持仓手数。每当策略持仓变化，记录一笔交易：包括时间、标的合约、交易方向（开多/平多/开空/平空）、成交价、数量、滑点和手续费扣减、该笔交易后的持仓和资金余额等信息。这些成交记录应保存在列表或DataFrame中，供统计模块进一步计算胜率、盈亏比等。回测需要计算收益率和风险指标，完整的逐笔交易记录是这些指标计算的基础。此外，引擎还应跟踪账户净值（或资金曲线）：可以假设初始资金，例如1000万，随着每笔交易盈亏和手续费更新账户余额。净值曲线通常以每天（或每Bar）结束时的账户总价值来表示，若持有未平仓头寸则按收盘价计算浮动盈亏纳入净值。输出的净值曲线将用于后续绩效指标（如年化收益、回撤）的计算和图表绘制。
- 
引擎模块可实现为一个核心类（如BacktestEngine），封装回测过程。在调用时传入数据模块、策略模块实例，以及初始资金、回测时间范围等参数，然后调用run_backtest()执行模拟。引擎内部维护数据指针和账户状态，主要函数包括：next_bar()获取下一时间步行情、process_signals()处理策略给出的信号变更、execute_trades()撮合交易更新持仓和资金、record_state()记录当前状态等。为了支持多标的，BacktestEngine可以管理一个字典维护每个合约的持仓和数据索引。同时，可设计一个Trade数据结构用于存储交易记录，每次交易发生时由引擎生成并保存。多线程实现可考虑使用Python的concurrent.futures或multiprocessing库，将不同合约或不同时间段分配到子进程处理。需要注意线程/进程间共享数据（如资金曲线）的同步，可通过队列或管道汇总子任务结果。在性能调优方面，可引入NumPy/Pandas/Polars批量运算以减少Python纯循环，加速计算收益序列和指标。总之，优先确保正确性，在此基础上再优化性能，并提供可配置的并行选项。

## 统计分析模块设计

统计模块负责对回测交易结果进行评估分析，计算关键绩效指标并生成相应图表。设计要点如下：
- 绩效指标计算：根据引擎输出的净值曲线和交易记录，统计模块应计算一系列策略表现指标：
  - 年化收益率：根据总回测天数和最终净值增长率计算年化复合收益。例如，设初始资金$P_0$，期末资金$P_T$，回测天数$D$，则年化收益≈$(P_T/P_0)^{(252/D)}-1$（若按252交易日折算年化）。
  - 最大回撤：衡量净值曲线在回测期间所经历的最大跌幅。可通过遍历净值序列，计算任意峰值后最大的百分比下降。强调最大回撤是评估策略风险的关键指标之一。统计模块应输出最大回撤的数值以及出现时间段。
  - 夏普比率 (Sharpe Ratio)：衡量单位波动率的超额收益。计算公式通常为$(R_p - R_f)/\sigma_p$，其中$R_p$为策略平均收益率（年化），$R_f$为无风险利率，$\sigma_p$为策略收益的年化波动率。统计模块可假设$R_f=0$或由用户配置，无风险利率取值会影响夏普率计算。通过夏普率可以评价策略收益相对于波动的性价比。
  - 胜率：即盈利交易次数占总交易次数的比例，以衡量策略交易信号的成功率。统计模块通过交易记录中每笔交易的盈亏情况来计算胜率，例如胜率=盈利交易数/总交易数。
  - 盈亏比：通常指平均每笔盈利与平均每笔亏损的比值，或称收益风险比。计算时需分别计算所有盈利交易的平均盈亏和所有亏损交易的平均盈亏，然后取平均盈利/平均亏损的绝对值，反映单笔交易盈亏幅度的相对大小。如果盈亏比远大于1且胜率适中，策略表现会较稳健。
  - 平均持仓周期：统计每笔交易从开仓到平仓所经历的平均时间（可按天或Bar数）。通过交易记录的时间戳差计算每笔交易持仓时长，再求均值。该指标反映策略交易频率和每次信号持仓的持续时间，结合其他指标可看出策略偏短线还是长线。
  - 其他指标：还可拓展计算诸如年化波动率、Calmar比率、Alpha和Beta（相对于基准）、信息比率等。

统计模块应将这些指标汇总整理，供报告模块展示。计算时需注意年化换算的周期数（交易日还是自然日）和收益序列中零收益或负收益情况对比率指标的影响。例如，当策略有亏损交易时盈亏比计算需取绝对值避免负值意义不明。所有公式和算法需在文档中注明假设，使结果具有可解释性。
- 图表生成：
  - 净值曲线（累计收益曲线）：显示回测期间策略账户净值的变化趋势，通常归一化初始净值为1或100%。曲线上升代表盈利，下降代表回撤。可在图中标注主要回撤区间或注释关键交易事件。
  - 回撤曲线：对应净值曲线的回撤百分比随时间变化图。通常通过计算每日（或每Bar）净值相对历史峰值的回落幅度来绘制。该曲线能直观显示策略经历过的回撤深度和持续时间。
  - 持仓情况可视化：反映策略在回测期内的仓位随时间变化的图表。例如绘制一个附属在价格曲线下方的柱状图或折线图表示持仓手数（多头为正、空头为负、空仓为零）。这样可以看到策略在什么时间段处于多头、空头或观望状态，以及仓位大小如何变化。对于多合约策略，可以绘制多条曲线分别表示各标的持仓，或用堆叠图表示总仓位构成。
  - 交易分布图：例如单笔收益分布直方图、月度收益统计图等，帮助分析策略收益来源和稳健性，可按需求添加。
- 图表生成过程可使用可视化库根据计算好的数据绘制，并保存为图像文件（如PNG）以便插入报告。要注意图表的美观易读，如添加标题、轴标签、图例、网格线以及合理的日期刻度格式等，使报告读者能够快速理解图中信息。

统计模块的实现可以采用Python的金融分析库和作图库组合。利用NumPy/Pandas方便地计算指标，例如最大回撤可以通过净值序列的rolling最大值来实现，夏普比率可通过numpy的均值和标准差函数计算。对于常见的年化收益等指标，亦可编写通用函数。若需要更可靠的金融指标计算，可考虑引入现有开源库，如PyPortfolio/Pyfolio 等，但自行实现可以更好地定制。图表绘制推荐使用Matplotlib 或 Plotly/Pyecharts 等库：Matplotlib适合生成静态图片用于PDF，Plotly/Pyecharts则能生成交互式图表用于HTML报告中嵌入。统计模块可以将指标和图表对象打包成一个结果数据结构（如字典包含各指标和图表路径），供报告模块直接使用。代码上，可以将指标计算函数和绘图函数解耦，分别封装，例如MetricsCalculator.calculate_all(perf_data)返回字典结果，Visualizer.plot_equity_curve(net_values)生成并保存曲线图。

## 报告输出模块设计

报告模块负责将回测结果整理成HTML/PDF报告和Excel明细。要点如下：

- HTML/PDF 综合报告：报告模块应生成包含策略描述、参数设置、回测期间、绩效摘要和图表的综合报告，可以选择输出为HTML页面或PDF文档两种格式（PDF可由HTML转换得到）。报告开头可列出本次回测的基本信息：例如策略名称和简要说明、回测标的（如IH当月连续合约）、时间区间、基础参数（初始资金、滑点、手续费率等）以及策略的核心参数配置。随后是绩效指标汇总表，列出年化收益、最大回撤、夏普率、胜率等关键指标数值。接下来用图表展示策略效果，如上一节生成的净值曲线图和回撤曲线图，可以并排或上下排列，附加简要的小结说明策略在何时收益较好、何时回撤显著。持仓可视化图表也可选取一并展示，以说明策略仓位随市场变化的关系。如果策略涉及多个合约或对冲关系，可在报告中解释各合约贡献。报告最后可以给出一些交易细节的总结，比如总交易次数、平均每笔收益，最大单笔盈利和亏损等。HTML报告可通过模板引擎自动填充上述内容：预先设计HTML模板，把文本段落、表格和图表占位符放好，使用例如Jinja2模板库，将计算得到的数据和图表路径替换进去生成最终的HTML文件。PDF报告可通过将HTML渲染为PDF（利用诸如wkhtmltopdf工具或WeasyPrint库）实现，或直接使用ReportLab等PDF库逐步拼装内容。如果希望简化流程，也可以仅输出HTML报告，由用户在浏览器中查看或自行打印为PDF。关键是报告模块应保证内容完整且版式美观，自动包含所有重要结果，让读者无需查阅原始数据即可了解策略表现。
- Excel明细报表：
  - 交易日志明细：一张表列出每笔交易记录，包括日期时间、合约、操作类型（开仓/平仓/多头/空头）、手数、开平仓价格、手续费、该笔交易盈亏、持仓变化后的净头寸等。通过交易日志，用户可复盘策略每一步的交易动作。对于买卖成对的交易，还可增加一列累计该笔平仓后的总盈亏。
  - 日级业绩汇总：若回测基于分钟或更高频率，还应提供逐日的汇总结果。一张表按日期列出：当日开盘净值、收盘净值、日收益率（当日净值变动百分比）、日内最大回撤、持仓情况摘要（如持仓天数或平均仓位）以及当日成交笔数、手续费总额等。如果回测粒度本身是日线，则此表与净值曲线类似，每行即为每日的数据点。日级汇总便于查看策略的逐日表现波动，以及对应行情情况做比对分析。
  - 净值曲线数据：一张表列出回测期间每个时点（每个Bar或者每日）的净值（账户权益）。这实际上就是净值曲线的数值形式，方便用户拿到其他工具中进一步处理。若频率太高（例如1分钟），可以考虑只输出日终净值，或者将全周期数据另存为CSV避免Excel行数限制。
  - 其他表：根据需要，可增加例如月度收益统计表、策略信号序列表（列出每个Bar目标仓位信号）等。总体上Excel文件可以包含多个sheet，各sheet命名清晰如“Trades”、“DailySummary”、“EquityCurve”等。

报告模块应提供将上述数据结构输出为Excel的方法。例如利用Pandas的to_excel()功能，一次性写入多个sheet，或使用xlsxwriter/openpyxl细化格式。写Excel时注意格式美观：如日期列格式化，数值列保留合理的小数位，盈亏用红/绿色标注（可通过条件格式实现）等，以提高可读性。

报告模块可以有一个主类如ReportGenerator，接受统计模块计算的结果和原始回测明细数据，然后执行报告生成。对于HTML报告，推荐使用Jinja2模板引擎：编写HTML模板文件，插入占位符如{{ strategy_name }}, {{ annual_return }}等，然后ReportGenerator加载模板并渲染输出实际HTML文件。图表可以以静态图片形式`（<img>标签）`嵌入，需确保在生成HTML前先保存图表文件，并在模板中引用正确的路径。对于Excel，可直接利用Pandas：例如将交易记录的DataFrame和每日汇总DataFrame写入Excel的不同sheet。使用pandas.ExcelWriter配合xlsxwriter可以添加一些单元格格式，但如无特殊要求直接输出数值即可。报告模块要注意的一个问题是文件存储路径和命名规范：可以按照策略名称和回测日期自动命名报告文件，以方便检索。总体而言，报告模块相对独立，只依赖统计分析结果和交易明细数据，生成过程不会影响回测本身。


## 关键技术与库选择

数据模块：采用pandas/polars读取CSV和处理数据；用datetime库解析时间；考虑使用pickle/HDF5或feather/Parquet（通过pyarrow）实现本地数据缓存提速；若需要从网络获取行情历史，可集成Tushare等数据接口库（扩展需求）。

策略模块：利用Python面向对象设计策略基类和子类；策略逻辑中可用NumPy/Pandas进行指标计算、信号判断；常用技术指标计算可考虑引入TA-Lib等库；通过灵活的参数管理（例如使用dataclass或配置文件）方便地调优策略参数；滑点和手续费等简单数值参数可直接配置，无需特殊库。

回测引擎：核心逻辑可用纯Python实现，配合NumPy加速数值计算；考虑使用Numba将关键循环JIT编译提升性能；并发方面，可使用concurrent.futures或multiprocessing实现多线程/多进程，亦可使用joblib等简化并行代码；如果未来考虑超高频回测，可将引擎关键部分用C++实现并通过Python扩展接口调用，以获得更高性能；日志记录可使用Python内置logging模块记录重要事件。

统计分析模块：充分使用pandas提供的金融计算便捷功能（如pct_change计算收益率，rolling计算回撤等）；复杂统计可用SciPy/NumPy进一步处理；绘图首选Matplotlib生成静态图，辅以seaborn提高美观度；如需要交互式图表用于HTML，则可选择Plotly或国内常用的pyecharts库来生成带交互的收益曲线和柱状图等。

报告模块：模板引擎Jinja2用于HTML报告拼装；WeasyPrint或 wkhtmltopdf工具用于将HTML转换PDF（也可考虑ReportLab直接写PDF，但控制版式难度较高）；Excel导出使用pandas.ExcelWriter结合XlsxWriter或OpenPyXL库实现；此外，可使用matplotlib自带的savefig或Plotly的图表保存功能将图表保存为文件插入报告。